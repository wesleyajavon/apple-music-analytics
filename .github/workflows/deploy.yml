# ============================================
# WORKFLOW: D√©ploiement Conditionnel sur Vercel
# ============================================
# Ce workflow d√©ploie sur Vercel UNIQUEMENT si CI passe.
#
# M√âTHODE : Utilise un Deploy Hook Vercel
# - Attend que CI passe
# - D√©clenche Vercel via webhook
#
# D√âCLENCHEMENT :
# - Seulement sur la branche main
# - Apr√®s que CI r√©ussisse
# ============================================

name: Deploy to Vercel

# QUAND d√©clencher ce workflow ?
on:
  # Seulement sur la branche principale
  push:
    branches:
      - main
      - master
  
  # Permet de d√©clencher manuellement depuis GitHub
  workflow_dispatch:

# ============================================
# JOBS
# ============================================
jobs:
  # Job: V√©rifier CI puis d√©ployer
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    
    steps:
      # √âTAPE 1: Attendre que CI passe
      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'CI'  # Nom du workflow CI
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10  # V√©rifie toutes les 10 secondes
          allowed-conclusions: success  # Accepte seulement le succ√®s
      
      # √âTAPE 2: D√©clencher le d√©ploiement Vercel via webhook
      - name: Trigger Vercel Deployment
        if: success()  # Seulement si CI a r√©ussi
        run: |
          echo "üöÄ Triggering Vercel deployment..."
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}"
          echo "‚úÖ Deployment triggered successfully"
      
      # √âTAPE 3: Confirmation
      - name: Deployment initiated
        if: success()
        run: |
          echo "‚úÖ CI checks passed"
          echo "‚úÖ Vercel deployment triggered"
          echo "Check Vercel dashboard for deployment status"

# ============================================
# CONFIGURATION REQUISE
# ============================================
# Pour que ce workflow fonctionne, vous devez :
#
# 1. Cr√©er un Deploy Hook dans Vercel :
#    - Vercel Dashboard > Votre Projet > Settings > Git > Deploy Hooks
#    - Cr√©ez un hook pour la branche "main"
#    - Copiez l'URL du hook
#
# 2. Ajouter le hook comme secret GitHub :
#    - GitHub > Repository > Settings > Secrets and variables > Actions
#    - Ajoutez un secret nomm√© : VERCEL_DEPLOY_HOOK_URL
#    - Collez l'URL du hook
#
# 3. (Optionnel) D√©sactiver auto-deploy dans Vercel :
#    - Vercel Dashboard > Settings > Git
#    - D√©sactivez "Automatic deployments" pour main
#    - Maintenant seul ce workflow d√©clenchera les d√©ploiements
#
# ALTERNATIVE (Plus Simple) :
# Si vous pr√©f√©rez garder l'auto-deploy Vercel, utilisez plut√¥t
# GitHub Branch Protection Rules pour emp√™cher les merges si CI √©choue.
# Voir SETUP_VERCEL_WAIT_FOR_CI.md pour les deux m√©thodes.
# ============================================

